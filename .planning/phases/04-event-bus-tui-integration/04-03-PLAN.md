---
phase: 04-event-bus-tui-integration
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - internal/config/save.go
  - internal/config/save_test.go
  - internal/tui/settings_pane.go
  - internal/tui/model.go
autonomous: true

must_haves:
  truths:
    - "User can press 's' to toggle the settings panel overlay"
    - "Settings panel displays editable fields for providers, agents, and workflow config"
    - "Saving settings writes JSON to the appropriate config file path"
    - "Pressing Escape or 's' again closes the settings panel and returns to normal view"
    - "Config changes are persisted to disk when the user completes the form"
  artifacts:
    - path: "internal/config/save.go"
      provides: "Config save function that writes OrchestratorConfig to JSON file"
      exports: ["Save"]
    - path: "internal/config/save_test.go"
      provides: "Tests for config save"
      min_lines: 30
    - path: "internal/tui/settings_pane.go"
      provides: "Huh-based settings form pane"
      exports: ["SettingsPaneModel"]
      min_lines: 80
  key_links:
    - from: "internal/tui/settings_pane.go"
      to: "internal/config/types.go"
      via: "Reads and modifies OrchestratorConfig fields"
      pattern: "OrchestratorConfig"
    - from: "internal/tui/settings_pane.go"
      to: "internal/config/save.go"
      via: "Calls Save after form completion"
      pattern: "config\\.Save"
    - from: "internal/tui/model.go"
      to: "internal/tui/settings_pane.go"
      via: "SettingsPaneModel field, toggled by 's' key"
      pattern: "settingsPane|showSettings"
---

<objective>
Add config save functionality and a TUI settings panel for editing global and per-project configuration.

Purpose: Fulfills requirements CONF-04 (global config editing) and CONF-05 (per-project config editing). Users can adjust providers, agents, and workflow settings without manually editing JSON files.

Output: `internal/config/save.go` for persisting config, `internal/tui/settings_pane.go` with Huh-based form, and updated `model.go` to toggle settings overlay.
</objective>

<execution_context>
@/Users/aristath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aristath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-event-bus-tui-integration/04-RESEARCH.md
@.planning/phases/04-event-bus-tui-integration/04-01-SUMMARY.md
@.planning/phases/04-event-bus-tui-integration/04-02-SUMMARY.md
@internal/config/types.go
@internal/config/loader.go
@internal/config/defaults.go
@internal/tui/model.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config save function and settings pane</name>
  <files>internal/config/save.go, internal/config/save_test.go, internal/tui/settings_pane.go</files>
  <action>
Install Huh dependency:
```bash
cd /Users/aristath/orchestrator && go get github.com/charmbracelet/huh
```

**save.go** -- Config persistence:

```go
func Save(cfg *OrchestratorConfig, path string) error
```

Implementation:
1. Marshal cfg to JSON with `json.MarshalIndent(cfg, "", "  ")`
2. Ensure parent directory exists with `os.MkdirAll(filepath.Dir(path), 0755)`
3. Write to file with `os.WriteFile(path, data, 0644)`
4. Return any errors wrapped with context

**save_test.go** -- Tests:
1. `TestSaveCreatesFile` -- save config to temp path, verify file exists and contains valid JSON
2. `TestSaveCreatesParentDir` -- save to nested path that doesn't exist, verify it creates dirs
3. `TestSaveRoundTrip` -- save config, load it back with Load(), verify fields match
4. `TestSaveOverwritesExisting` -- save twice with different values, verify second write wins

**settings_pane.go** -- Huh-based settings form:

IMPORTANT: Check the actual Huh library API after installing. The research shows `huh.NewForm`, `huh.NewGroup`, `huh.NewInput`, `huh.NewSelect`. Verify these exist and use the correct API. Huh forms integrate with Bubble Tea via their own Update/View methods.

```go
type SettingsPaneModel struct {
    form        *huh.Form
    config      *config.OrchestratorConfig
    savePath    string // "global" or "project" -- determines save target
    globalPath  string
    projectPath string
    width       int
    height      int
    visible     bool
    saved       bool
    err         error
}
```

Constructor: `NewSettingsPaneModel(cfg *config.OrchestratorConfig, globalPath, projectPath string) SettingsPaneModel`

Build the Huh form with these groups:

**Group 1: "Save Target"**
- Select field: "Save to" with options "Global (~/.orchestrator/config.json)" and "Project (.orchestrator/config.json)"

**Group 2: "Default Agent Settings"**
- Input field: "Coder Provider" (value from cfg.Agents["coder"].Provider)
- Input field: "Coder Model" (value from cfg.Agents["coder"].Model)
- Input field: "Reviewer Provider" (value from cfg.Agents["reviewer"].Provider)
- Input field: "Reviewer Model" (value from cfg.Agents["reviewer"].Model)

**Group 3: "Provider Settings"**
- Input field: "Claude Command" (value from cfg.Providers["claude"].Command)
- Input field: "Codex Command" (value from cfg.Providers["codex"].Command)
- Input field: "Goose Command" (value from cfg.Providers["goose"].Command)

Note: Huh forms bind to string pointers. Create local string variables from the config, bind to them, then copy back to config on completion.

Methods:
- `Init() tea.Cmd` -- return form's Init()
- `Update(msg tea.Msg) (SettingsPaneModel, tea.Cmd)`:
  - Delegate to form.Update()
  - If form state is completed: copy form values back to config struct, call `config.Save(cfg, selectedPath)`, set saved=true
  - Handle Escape key: set visible=false (cancel without saving)
- `View() string` -- if not visible, return "". Otherwise render form with a styled border and title "Settings". Show "Saved!" message briefly after successful save.
- `SetSize(w, h int)` -- update dimensions
- `SetVisible(v bool)` / `IsVisible() bool` -- toggle visibility

Run: `go test -race ./internal/config/...` to verify save tests.
  </action>
  <verify>
`go build ./internal/config/...` compiles.
`go build ./internal/tui/...` compiles.
`go test -race -v ./internal/config/...` -- all config tests pass (existing + new save tests).
`go vet ./internal/...` -- no issues.
  </verify>
  <done>
Config save function exists and is tested. Settings pane renders a Huh form with provider/agent fields and save target selection. Form completion persists config to disk.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate settings pane into TUI root model</name>
  <files>internal/tui/model.go, cmd/orchestrator/main.go</files>
  <action>
**model.go changes:**

1. Add `settingsPane SettingsPaneModel` field to Model struct.
2. Add `showSettings bool` field.
3. Add `config *config.OrchestratorConfig` and `globalConfigPath, projectConfigPath string` fields.

4. Update constructor `New()` to accept config and paths:
```go
func New(eventBus *events.EventBus, cfg *config.OrchestratorConfig, globalPath, projectPath string) Model
```
Initialize settingsPane with `NewSettingsPaneModel(cfg, globalPath, projectPath)`.

5. In `Update()`, handle 's' key:
   - If showSettings is true and 's' or 'escape' pressed: set showSettings=false, settingsPane.SetVisible(false)
   - If showSettings is false and 's' pressed: set showSettings=true, settingsPane.SetVisible(true)
   - When showSettings is true, route ALL key messages to settingsPane.Update() instead of normal panes (settings is a modal overlay)

6. In `Update()`, handle WindowSizeMsg: also forward to settingsPane.SetSize()

7. In `View()`:
   - If showSettings is true: render settings pane centered as overlay on top of the normal view. The simplest approach: render settings pane full-screen (replace normal view). Or render the settings view in the center 60% of the screen with a border.
   - If showSettings is false: render normal split-pane layout as before

**cmd/orchestrator/main.go changes:**

Update the main function to load config and pass it to tui.New():
```go
cfg, err := config.LoadDefault()
if err != nil {
    fmt.Fprintf(os.Stderr, "Error loading config: %v\n", err)
    os.Exit(1)
}

homeDir, _ := os.UserHomeDir()
globalPath := filepath.Join(homeDir, ".orchestrator", "config.json")
projectPath := filepath.Join(".orchestrator", "config.json")

model := tui.New(bus, cfg, globalPath, projectPath)
```

Add the config import.

Build and verify: `go build -o /tmp/orchestrator-demo ./cmd/orchestrator/`
  </action>
  <verify>
`go build ./...` -- entire project compiles.
`go vet ./...` -- no issues.
`go test -race ./internal/...` -- all tests pass, no regressions.
`go build -o /tmp/orchestrator-demo ./cmd/orchestrator/` -- binary compiles.
  </verify>
  <done>
Settings panel integrated into TUI. Pressing 's' toggles the settings overlay. Form edits can be saved to global or project config file. Escape cancels. Normal TUI view resumes after settings close. Binary compiles and all tests pass.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- entire project compiles
2. `go vet ./...` -- no vet issues
3. `go test -race ./internal/...` -- full test suite passes
4. Settings panel toggles with 's' key
5. Config save writes valid JSON to specified path
6. Save round-trip preserves all config fields
</verification>

<success_criteria>
- Config save function persists OrchestratorConfig to JSON with proper directory creation
- Settings pane displays editable fields for providers and agents
- Save target selection (global vs project) determines file path
- Form completion triggers config save to disk
- Settings panel toggles cleanly as modal overlay
- All tests pass including new config save tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-event-bus-tui-integration/04-03-SUMMARY.md`
</output>
