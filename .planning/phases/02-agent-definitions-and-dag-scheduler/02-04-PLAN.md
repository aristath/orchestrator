---
phase: 02-agent-definitions-and-dag-scheduler
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-03"]
files_modified:
  - internal/scheduler/workflow.go
  - internal/scheduler/workflow_test.go
autonomous: true

must_haves:
  truths:
    - "Predefined workflows (code -> review -> test) can be configured"
    - "After task completion, orchestrator spawns follow-up agents per workflow config"
    - "Workflow follow-up tasks are added to the same DAG with proper dependencies"
    - "Workflow config that creates cycles is rejected"
  artifacts:
    - path: "internal/scheduler/workflow.go"
      provides: "WorkflowManager that spawns follow-up tasks based on workflow config"
      contains: "type WorkflowManager struct"
    - path: "internal/scheduler/workflow_test.go"
      provides: "Tests for workflow follow-up spawning and cycle rejection"
      contains: "func TestWorkflowManager"
  key_links:
    - from: "internal/scheduler/workflow.go"
      to: "internal/scheduler/dag.go"
      via: "Adds follow-up tasks to DAG and re-validates"
      pattern: "dag\\.AddTask"
    - from: "internal/scheduler/workflow.go"
      to: "internal/config/types.go"
      via: "Reads WorkflowConfig to determine follow-up steps"
      pattern: "config\\.WorkflowConfig"
---

<objective>
Workflow engine that spawns follow-up agents after task completion.

Purpose: When a "coder" task completes, the workflow config (code -> review -> test) should automatically create "reviewer" and "tester" tasks that depend on the completed task. These follow-up tasks are added to the same DAG, enabling proper dependency tracking and preventing the need for a separate execution queue.

Output: `internal/scheduler/workflow.go` with WorkflowManager and tests.
</objective>

<execution_context>
@/Users/aristath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aristath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-definitions-and-dag-scheduler/02-RESEARCH.md
@.planning/phases/02-agent-definitions-and-dag-scheduler/02-01-SUMMARY.md
@.planning/phases/02-agent-definitions-and-dag-scheduler/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: WorkflowManager for follow-up task spawning</name>
  <files>internal/scheduler/workflow.go</files>
  <action>
Create `internal/scheduler/workflow.go`:

```go
// WorkflowManager handles spawning follow-up tasks based on workflow configuration.
// When a task completes, it checks if the task's agent role is a step in any
// configured workflow, and if so, creates the next step's task in the DAG.
type WorkflowManager struct {
    dag       *DAG
    workflows map[string]config.WorkflowConfig // workflow name -> config
}
```

Constructor: `NewWorkflowManager(dag *DAG, workflows map[string]config.WorkflowConfig) *WorkflowManager`

Methods:

- `OnTaskCompleted(completedTask *Task) ([]*Task, error)` -- the main hook called after a task completes:
  1. Find which workflow(s) the completed task's AgentRole participates in
  2. For each matching workflow, find the NEXT step after the current agent role
  3. If there is a next step, create a new Task:
     - ID: `{completedTask.ID}-{nextStepAgent}` (e.g., "task1-reviewer")
     - AgentRole: the next step's agent role
     - Prompt: `"Review the output of task {completedTask.ID}: {completedTask.Result}"` (the prompt template is simple for now -- Phase 3+ will refine)
     - DependsOn: `[completedTask.ID]`
     - WritesFiles: same as completed task (reviewer/tester may write to same files)
     - FailureMode: FailSoft for review tasks (code can proceed), FailHard for test tasks
  4. Add the new task to the DAG via `dag.AddTask()`
  5. Re-validate the DAG to catch any cycles introduced by workflow tasks
  6. If validation fails (cycle), remove the added task and return error
  7. Return the list of newly created tasks

- `FindWorkflow(agentRole string) (string, *config.WorkflowConfig, int)` -- returns workflow name, config, and step index for the given agent role. Returns empty string if not found.

Import `internal/config` for the WorkflowConfig type. The config types should already be importable from the same module.

Important edge cases:
- A task's agent role might not be in any workflow (no follow-ups needed) -- return empty list, no error
- A task might be the LAST step in a workflow (no next step) -- return empty list, no error
- Multiple workflows could reference the same agent role -- process all of them
  </action>
  <verify>
Run `cd /Users/aristath/orchestrator && go build ./internal/scheduler/` -- must compile.
  </verify>
  <done>
WorkflowManager creates follow-up tasks when a task's agent role matches a workflow step, adds them to the DAG with proper dependencies, and re-validates to catch cycles.
  </done>
</task>

<task type="auto">
  <name>Task 2: WorkflowManager tests</name>
  <files>internal/scheduler/workflow_test.go</files>
  <action>
Create `internal/scheduler/workflow_test.go` with table-driven tests:

1. **Standard workflow (code -> review -> test)**: Complete a "coder" task. OnTaskCompleted creates a "reviewer" follow-up task. Complete the reviewer task. OnTaskCompleted creates a "tester" follow-up task. Verify chain: coder -> reviewer -> tester.

2. **Last step no follow-up**: Complete a "tester" task (last step in standard workflow). OnTaskCompleted returns empty list, no error.

3. **No matching workflow**: Complete a task with AgentRole "custom-agent" not in any workflow. Returns empty list, no error.

4. **Follow-up task has correct dependencies**: Create coder task "task-1", complete it, verify follow-up reviewer task has DependsOn = ["task-1"].

5. **Follow-up task ID format**: Verify the follow-up task ID is "{originalID}-{agentRole}" (e.g., "task-1-reviewer").

6. **DAG re-validation on follow-up**: Manually create a scenario where adding a follow-up would create a cycle (contrived: workflow says A -> B, but B already depends on something that depends on the follow-up's dependents). Verify error is returned and DAG is not corrupted.

7. **Multiple workflows**: Define two workflows both containing "coder" as a step (e.g., "standard" and "security"). Complete a coder task. Verify follow-ups from BOTH workflows are created.

Setup helper: create a function that builds a DAG with a standard workflow config for reuse across tests.
  </action>
  <verify>
Run `cd /Users/aristath/orchestrator && go test ./internal/scheduler/ -run TestWorkflowManager -v -count=1 -race` -- all tests pass.
  </verify>
  <done>
WorkflowManager tests cover standard pipeline, last-step handling, no-match, dependency correctness, ID format, cycle rejection, and multiple workflows. All pass under -race.
  </done>
</task>

</tasks>

<verification>
- `go build ./internal/scheduler/` compiles
- `go test ./internal/scheduler/ -v -count=1 -race` all tests pass
- `go vet ./internal/scheduler/` no issues
- Workflow follow-ups create proper DAG dependency chains
- Cycle-inducing workflows are rejected
</verification>

<success_criteria>
- OnTaskCompleted creates next-step follow-up tasks with correct agent role and dependencies
- Follow-up tasks are in the same DAG (not separate execution queue)
- Last-step tasks and non-workflow tasks produce no follow-ups (no error)
- DAG re-validation catches cycles from workflow-added tasks
- All tests pass under -race flag
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-definitions-and-dag-scheduler/02-04-SUMMARY.md`
</output>
