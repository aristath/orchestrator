---
phase: 02-agent-definitions-and-dag-scheduler
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/config/types.go
  - internal/config/defaults.go
  - internal/config/loader.go
  - internal/config/loader_test.go
autonomous: true

must_haves:
  truths:
    - "Providers are defined in JSON config separately from agents"
    - "Agents are defined in JSON config with provider, model, system prompt, tools per role"
    - "Default roles (orchestrator, coder, reviewer, tester) are usable without custom config"
    - "Global config and per-project config are loaded and merged with project overriding global"
  artifacts:
    - path: "internal/config/types.go"
      provides: "ProviderConfig, AgentConfig, WorkflowConfig, OrchestratorConfig structs"
      contains: "type OrchestratorConfig struct"
    - path: "internal/config/defaults.go"
      provides: "Default provider and agent definitions"
      contains: "func DefaultConfig"
    - path: "internal/config/loader.go"
      provides: "Config loading from global + project paths with merge"
      contains: "func Load"
    - path: "internal/config/loader_test.go"
      provides: "Tests for config loading, merging, defaults"
      contains: "func TestLoad"
  key_links:
    - from: "internal/config/loader.go"
      to: "internal/config/types.go"
      via: "Unmarshal into OrchestratorConfig"
      pattern: "json\\.Unmarshal.*OrchestratorConfig"
    - from: "internal/config/loader.go"
      to: "internal/config/defaults.go"
      via: "Start with defaults, overlay loaded config"
      pattern: "DefaultConfig"
---

<objective>
Configuration system for providers, agents, and workflows.

Purpose: All other Phase 2 subsystems need config types (AgentConfig references a ProviderConfig, workflows reference agent roles). This plan creates the type definitions, built-in defaults, and the two-file config loader with merge semantics.

Output: `internal/config/` package with types, defaults, loader, and tests.
</objective>

<execution_context>
@/Users/aristath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aristath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-agent-definitions-and-dag-scheduler/02-RESEARCH.md
@internal/backend/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config types and default definitions</name>
  <files>internal/config/types.go, internal/config/defaults.go</files>
  <action>
Create `internal/config/types.go` with the following structs:

```go
// ProviderConfig defines a transport layer (CLI command, args, base settings).
// Providers are separate from agents -- multiple agents can share one provider.
type ProviderConfig struct {
    Command string   `json:"command"`          // CLI binary name (e.g., "claude", "codex", "goose")
    Args    []string `json:"args,omitempty"`   // Default args appended to every invocation
    Type    string   `json:"type"`             // Backend type matching backend.Config.Type: "claude", "codex", "goose"
}

// AgentConfig defines a role that uses a specific provider and model.
type AgentConfig struct {
    Provider     string   `json:"provider"`               // Key into Providers map
    Model        string   `json:"model,omitempty"`         // Model override (e.g., "opus-4", "gpt-4.1")
    SystemPrompt string   `json:"system_prompt,omitempty"` // Role-specific system prompt
    Tools        []string `json:"tools,omitempty"`         // Allowed tools for this role
}

// WorkflowStepConfig defines one step in a workflow pipeline.
type WorkflowStepConfig struct {
    Agent string `json:"agent"` // Key into Agents map
}

// WorkflowConfig defines a pipeline of agent steps (e.g., code -> review -> test).
type WorkflowConfig struct {
    Steps []WorkflowStepConfig `json:"steps"`
}

// OrchestratorConfig is the top-level configuration.
type OrchestratorConfig struct {
    Providers map[string]ProviderConfig `json:"providers"`
    Agents    map[string]AgentConfig    `json:"agents"`
    Workflows map[string]WorkflowConfig `json:"workflows"`
}
```

Create `internal/config/defaults.go` with a `DefaultConfig()` function that returns an `OrchestratorConfig` with:

**Default providers:**
- `"claude"`: Command "claude", Type "claude"
- `"codex"`: Command "codex", Type "codex"
- `"goose"`: Command "goose", Type "goose"

**Default agents (4 roles):**
- `"orchestrator"`: Provider "claude", SystemPrompt describing plan coordination role
- `"coder"`: Provider "claude", SystemPrompt describing implementation role
- `"reviewer"`: Provider "claude", SystemPrompt describing code review role
- `"tester"`: Provider "claude", SystemPrompt describing test writing role

**Default workflows:**
- `"standard"`: Steps: coder -> reviewer -> tester

Use Go structs (not embedded JSON) for compile-time validation. Keep system prompts short (1-2 sentences each) -- they will be customized by users.
  </action>
  <verify>
Run `cd /Users/aristath/orchestrator && go build ./internal/config/` -- must compile without errors.
  </verify>
  <done>
types.go defines ProviderConfig, AgentConfig, WorkflowStepConfig, WorkflowConfig, and OrchestratorConfig. defaults.go returns a valid OrchestratorConfig with 3 providers, 4 agents, and 1 workflow. Both compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Config loader with global/project merge and tests</name>
  <files>internal/config/loader.go, internal/config/loader_test.go</files>
  <action>
Create `internal/config/loader.go` with a `Load(globalPath, projectPath string) (*OrchestratorConfig, error)` function that:

1. Starts with `DefaultConfig()` as the base
2. If `globalPath` exists, reads and unmarshals it, then merges into base:
   - For each provider in global config, set/override in base.Providers map
   - For each agent in global config, set/override in base.Agents map
   - For each workflow in global config, set/override in base.Workflows map
3. If `projectPath` exists, reads and unmarshals it, then merges into the result from step 2 using same logic
4. Returns the merged config

Use `encoding/json` from stdlib (no external config library -- consistent with Phase 1's zero-dependency approach). The merge is map-key-level: project config can add new agents or override specific agents without redefining everything.

Also add a helper `LoadDefault() (*OrchestratorConfig, error)` that calls `Load` with the conventional paths:
- Global: `~/.orchestrator/config.json` (use `os.UserHomeDir()`)
- Project: `.orchestrator/config.json` (relative to cwd)

Handle gracefully: missing files are not errors (just skip), but malformed JSON IS an error.

Create `internal/config/loader_test.go` with table-driven tests:

1. **No config files**: Returns defaults (3 providers, 4 agents, 1 workflow)
2. **Global only**: Global adds a new agent "css-specialist" with provider "goose" -- result has 5 agents
3. **Project only**: Project overrides "coder" agent to use provider "codex" -- result has 4 agents but coder uses codex
4. **Both with merge**: Global adds "css-specialist", project overrides "coder" to use codex -- result has 5 agents, coder uses codex
5. **Malformed JSON**: Returns error with descriptive message
6. **Project overrides global**: Global sets coder model to "X", project sets coder model to "Y" -- result has model "Y"

Use `t.TempDir()` for test config files. Write JSON to temp files, pass paths to `Load()`.
  </action>
  <verify>
Run `cd /Users/aristath/orchestrator && go test ./internal/config/ -v -count=1` -- all tests pass.
  </verify>
  <done>
loader.go loads and merges global + project JSON configs over defaults. All 6+ test cases pass covering defaults-only, global-only, project-only, merge, malformed JSON, and override precedence.
  </done>
</task>

</tasks>

<verification>
- `go build ./internal/config/` compiles
- `go test ./internal/config/ -v -count=1` all tests pass
- `go vet ./internal/config/` no issues
</verification>

<success_criteria>
- OrchestratorConfig struct exists with Providers, Agents, Workflows maps
- DefaultConfig() returns 3 providers, 4 agents (orchestrator/coder/reviewer/tester), 1 workflow
- Load() merges global -> project -> defaults with correct override precedence
- All tests pass including edge cases (missing files, malformed JSON, override semantics)
</success_criteria>

<output>
After completion, create `.planning/phases/02-agent-definitions-and-dag-scheduler/02-01-SUMMARY.md`
</output>
